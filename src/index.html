<!DOCTYPE html>
<html lang="en">
<head>
	
	<!-- HTML Metadata -->
	
    <meta charset="UTF-8">
    <title>Game</title>
	
	
	<!-- Third-Party Imports - Bootstrap & jQuery -->
	
	<link href="./libraries/bootstrap/bootstrap.min.css" rel="stylesheet">
	<link href="./libraries/bootstrap/bootstrap-icons.min.css" rel="stylesheet">
	<script src="./libraries/bootstrap/bootstrap.bundle.min.js"></script>
	<script src="./libraries/jquery/jquery-3.7.1.min.js"></script>
	
	<!-- Game CSS -->
	
	<link rel="stylesheet" href="./style.css">
	
</head>
<body>
	
	<!-- Special UIs -->
	
	<!-- Debug UI -->
	
	<div id="debug" class="mx-3" style="display: none;">
		<div class="row">
			<div class="debug-window col">
				<div class="card mt-3 shadow-sm">
					<div class="card-body">
						<p class="card-title small fw-bold">Debug Info</p>
						<p id="debug-text" class="card-text small mb-1"></p>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- Editor UI -->
	
	<div id="editor" class="mx-3" style="display: none;">
		<div id="editor-title" class="row">
			<div class="editor-window col-12 col-lg-7 col-xl-5">
				<div class="card p-2 mt-3 shadow-sm">
					<div class="input-group">
						<div class="card-title fw-bold input-group-text w-100 m-0">
							Edit World
							<div class="vr ms-3"></div>
							<input id="editor-world-name" class="form-control form-control-sm w-auto mx-3" placeholder="Enter your world's name." type="text"
							data-bs-title="Enter your world's name." data-bs-toggle="tooltip" data-bs-placement="bottom">
							<div class="vr me-3"></div>
							<button id="editor-world-new" type="button" class="btn btn-sm btn-outline-secondary ms-0 me-1"
							data-bs-title="Create a new world." data-bs-toggle="tooltip" data-bs-placement="bottom">
								<i class="bi bi-file-earmark"></i>
							</button>
							<button id="editor-world-load" type="button" class="btn btn-sm btn-outline-secondary mx-1"
							data-bs-title="Import world from JSON." data-bs-toggle="tooltip" data-bs-placement="bottom">
								<i class="bi bi-folder2-open"></i>
							</button>
							<button id="editor-world-save" type="button" class="btn btn-sm btn-outline-secondary ms-1 me-0"
							data-bs-title="Export world to JSON." data-bs-toggle="tooltip" data-bs-placement="bottom">
								<i class="bi bi-floppy"></i>
							</button>
							<div class="vr mx-3"></div>
							<button id="editor-world-geometry-plane" type="button" class="btn btn-sm btn-outline-secondary ms-0 me-1"
							data-bs-title="Spawn a new plane object." data-bs-toggle="tooltip" data-bs-placement="bottom">
								<i class="bi bi-square"></i>
							</button>
							<button id="editor-world-geometry-box" type="button" class="btn btn-sm btn-outline-secondary mx-1"
							data-bs-title="Spawn a new box object." data-bs-toggle="tooltip" data-bs-placement="bottom">
								<i class="bi bi-box"></i>
							</button>
							<button id="editor-world-geometry-cylinder" type="button" class="btn btn-sm btn-outline-secondary mx-1"
							data-bs-title="Spawn a new cylinder object." data-bs-toggle="tooltip" data-bs-placement="bottom">
								<i class="bi bi-database"></i>
							</button>
							<button id="editor-world-geometry-sphere" type="button" class="btn btn-sm btn-outline-secondary mx-1"
							data-bs-title="Spawn a new sphere object." data-bs-toggle="tooltip" data-bs-placement="bottom">
								<i class="bi bi-globe"></i>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="editor-selected-object" class="row" style="display: none;">
			<div class="editor-window col-6 col-md-5 col-lg-4 col-xl-2">
				<div class="card pt-2 ps-2 pe-2 pb-3 mt-3 shadow-sm">
					<div class="card-title small-important fw-bold input-group-text w-100">
						Selected Object
					</div>
					<div id="editor-selected-object-position" class="mb-1">
						<label class="form-label small">Position</label>
						<div class="d-flex flex-wrap flex-sm-nowrap justify-content-center">
							<div class="flex-fill mx-1">
								<label class="mt-1 small">X: </label>
								<input id="editor-selected-object-position-x" class="form-control form-control-sm" placeholder="X" type="text"
								data-bs-title="The object's position on the X-axis." data-bs-toggle="tooltip">
							</div>
							<div class="flex-fill mx-1">
								<label class="mt-1 small">Y: </label>
								<input id="editor-selected-object-position-y" class="form-control form-control-sm" placeholder="Y" type="text"
								data-bs-title="The object's position on the Y-axis." data-bs-toggle="tooltip">
							</div>
							<div class="flex-fill mx-1">
								<label class="mt-1 small">Z: </label>
								<input id="editor-selected-object-position-z" class="form-control form-control-sm" placeholder="Z" type="text"
								data-bs-title="The object's position on the Z-axis." data-bs-toggle="tooltip">
							</div>
						</div>
					</div>
					<div id="editor-selected-object-scale" class="mb-1">
						<label class="form-label small mt-2 mb-0">Scale</label>
						<div class="d-flex flex-wrap flex-sm-nowrap justify-content-center">
							<div class="flex-fill mx-1">
								<label class="mt-1 small">X: </label>
								<input id="editor-selected-object-scale-x" class="form-control form-control-sm" placeholder="X" type="text"
								data-bs-title="The object's size on the X-axis as a percentage." data-bs-toggle="tooltip">
							</div>
							<div class="flex-fill mx-1">
								<label class="mt-1 small">Y: </label>
								<input id="editor-selected-object-scale-y" class="form-control form-control-sm" placeholder="Y" type="text"
								data-bs-title="The object's size on the Y-axis as a percentage." data-bs-toggle="tooltip">
							</div>
							<div class="flex-fill mx-1">
								<label class="mt-1 small">Z: </label>
								<input id="editor-selected-object-scale-z" class="form-control form-control-sm" placeholder="Z" type="text"
								data-bs-title="The object's size on the Z-axis as a percentage." data-bs-toggle="tooltip">
							</div>
						</div>
					</div>
					<div id="editor-selected-object-rotation" class="mb-1">
						<label class="form-label small mt-2 mb-0">Rotation</label>
						<div class="d-flex flex-wrap flex-sm-nowrap justify-content-center">
							<div class="flex-fill mx-1">
								<label class="mt-1 small">X: </label>
								<input id="editor-selected-object-rotation-x" class="form-control form-control-sm" placeholder="X" type="text"
								data-bs-title="The object's X-axis rotation in degrees." data-bs-toggle="tooltip">
							</div>
							<div class="flex-fill mx-1">
								<label class="mt-1 small">Y: </label>
								<input id="editor-selected-object-rotation-y" class="form-control form-control-sm" placeholder="Y" type="text"
								data-bs-title="The object's Y-axis rotation in degrees." data-bs-toggle="tooltip">
							</div>
							<div class="flex-fill mx-1">
								<label class="mt-1 small">Z: </label>
								<input id="editor-selected-object-rotation-z" class="form-control form-control-sm" placeholder="Z" type="text"
								data-bs-title="The object's Z-axis rotation in degrees." data-bs-toggle="tooltip">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- Menu UIs -->
	
	<!-- Main Menu -->
	
	<div id="menu" class="modal modal-sheet bg-body-secondary p-4 py-md-5">
		<div class="modal-dialog">
			<div class="modal-content rounded-4 shadow">
				<div class="modal-body p-5">
					<div class="d-flex justify-content-center">
						<h2 class="fw-bold mb-3">Main Menu</h2>
					</div>
					<div class="d-flex mb-3 justify-content-center">
						<button id="startGame" type="button" class="btn btn-lg btn-primary w-100">Start</button>
					</div>
					<div class="d-flex justify-content-center">
						<button id="exitGame" type="button" class="btn btn-lg btn-primary w-100">Exit</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- Game UI Elements -->
	
	<!-- Player Crosshair -->
	
	<div class="crosshair"></div>
	
	
	<!-- three.js Renderer -->
	
	<div id="renderer"></div>
	
	
	<!-- Game JS -->
	
    <script type="module">
		
		// Game Imports
		
		// three.js Imports
		import * as THREE from './libraries/threejs/three.js';
		import { PointerLockControls } from './libraries/threejs/modules/PointerLockControls.js';
		import { TransformControls } from './libraries/threejs/modules/TransformControls.js';
		
		// Class Imports
		import Player from './classes/player.class.js';
		import World from './classes/world.class.js';
		
		// Game World Imports
		import * as Worlds from './worlds/worlds.js';
		
		
		// Game Declarations
		
		// three.js Game Renderer
        let renderer, render_once, stop_animating;
		
		// Game Player
		let player;
		
		// Game World
		let worlds, world, editor, debug;
		
		// Game Textures
		let textures, texture_loader;
		
		
		// Game Functions
		
		/**
		 * Game Initialization - Initializes the game renderer/textures/world/player, then starts the game loop.
		 */
		function Initialize()
		{
			
			// --------------------------------------------------------------------------------
			// Game Initialization Flow:
			//
			// init() -> loadTextures() -> loadWorlds() -> animate()
			// --------------------------------------------------------------------------------
			//
			//	init()
			//
			//	Sets up the three.js renderer and starts to
			//	initialize textures.
			// --------------------------------------------------------------------------------
			//
			//	loadTextures()
			//
			//	Loads textures from "textures.json" in the textures folder. Loading textures
			//	takes time, and loading worlds can only happen when all textures are loaded,
			//	so loading worlds happens afterward in a callback.
			// --------------------------------------------------------------------------------
			//
			//	loadWorlds()
			//
			//	Right now this function sucks. This will soon load worlds from "worlds.json"
			//	in the worlds folder. This will also have a callback which starts the
			//	game loop.
			// --------------------------------------------------------------------------------
			//
			//	animate()
			//
			//	This is the game loop.
			// --------------------------------------------------------------------------------
			
			// Initialize three.js renderer
			renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			render_once = false;
			stop_animating = false;
			$('#renderer').append(renderer.domElement);
			
			// Initialize textures
			textures = {};
			texture_loader = new THREE.TextureLoader();
			
			// Initialize worlds
			worlds = {};
			world_loader = new THREE.ObjectLoader();
			
			// Load textures
			fetch('./textures/textures.json').then(response => response.json()).then(texture_paths => { loadTextures(texture_paths, function() {
			
				// Load worlds
				fetch('./worlds/worlds.json').then(response => response.json()).then(world_paths => { loadWorlds(world_paths, animate); }).catch(error => {
					
					// Error loading worlds
					console.error("Error loading worlds.json: ", error);
					
				});
			
			}); }).catch(error => {
				
				// Error loading textures
				console.error("Error loading textures.json: ", error);
				
			});
			
		}
		
		/**
		 * Load Textures - Initializes game textures according to the list of textures in the textures.json file.
		 */
		function loadTextures(texture_paths, callback)
		{
			
			let count = 0;
			
			// Get all keys (texture names) from the list of texture paths
			const texture_keys = Object.keys(texture_paths);
			
			// Load each texture
			texture_keys.forEach((key) => {
				texture_loader.load(texture_paths[key], (texture) => {
					
					// Store each loaded texture by name
					textures[key] = texture;
					
					// Increment the texture count to check if all textures are loaded
					count++;
					if (count === texture_keys.length)
					{
						
						// All textures are loaded, now perform the next step using the callback function
						callback();
						
					}
				},
				undefined, // No onProgress callback
				(error) => {
					
					// Error loading texture
					console.error("Error loading texture: ", error);
					
				});
				
			});
			
		}
		
		/**
		 * Load Worlds - Initializes game worlds according to the list of worlds in the worlds.json file.
		 */
		function loadWorlds(world_paths, callback)
		{
			
			let count = 0;
			
			// Get all keys (world names) from the list of world paths
			const world_keys = Object.keys(world_paths);
			
			// Load each world
			world_keys.forEach((key) => {
				texture_loader.load(world_paths[key], (texture) => {
					
					// Store each loaded texture by name
					textures[key] = texture;
					
					// Increment the texture count to check if all textures are loaded
					count++;
					if (count === world_keys.length)
					{
						
						// All textures are loaded, now perform the next step using the callback function
						callback();
						
					}
				},
				undefined, // No onProgress callback
				(error) => {
					
					// Error loading texture
					console.error("Error loading texture: ", error);
					
				});
				
			});
			
		}
		
		/**
		 * Load Worlds - Initializes game worlds using the Worlds class (this will be modified later).
		 */
		function loadWorlds()
		{
			
			// Initialize worlds
			worlds = [];
			
			// Initialize custom game worlds from Worlds class
			for (const world_class in Worlds)
			{
				const game_world = new Worlds[world_class](textures);
				if (game_world.world)
				{
					worlds.push(game_world.world);
				}
			}
			
			// Load game world
			if (worlds.length > 0)
			{
				
				// Select the first available game world by default
				world = worlds[0];
				
				// Initialize player
				player = new Player(window, document, renderer, world);
				
				// Start game loop
				animate();
				
			}
			else
			{
				// TODO: No game worlds loaded, crash the game? :(
			}
			
		}
		
		/**
		 * Game Loop - Handles game processes that update every frame, then renders the frame.
		 */
		function animate()
		{
			
			// Request a frame to be rendered using this method as a callback
			const frame_id = requestAnimationFrame(animate);
			
			// Make sure at least one frame is rendered (This is workaround for collision bounding boxes before handling ANY collision detection...)
			//
			// 	NOTE: One frame must be initially rendered because the THREE.Box3().setFromObject() function expects objects to have a 
			//	      matrixWorld property that is up-to-date first, so rendering a single frame before collision detection prevents a crash.
			if (render_once)
			{
				
				// Update player movement, collision detection, etc.
				player.update(world);
				
				// Update in-game editor
				editor.update(world);
				
				// Update in-game debugger
				debug.update(world);
				
			}
			else
			{
				render_once = true;
			}
			
			// Render the frame (or break game loop if flag is set)
			if (!stop_animating)
			{
				renderer.render(world.scene, player.camera);
			}
			else
			{
				cancelAnimationFrame(frame_id);
				
				// TODO: Game loop broken. Do something? Show main menu?
			}
			
		}
		
		
		// Browser Window Event Handlers
		
		/**
		 * Window load event.
		 */
		window.onload = function(e)
		{ 
			
			// Initialize bootstrap tooltips
			const tooltipList = $('[data-bs-toggle="tooltip"]').each(function() { new bootstrap.Tooltip($(this)); });
			
			// ---------------- TODO: REMOVE EVERYTHING BELOW THIS LINE  ----------------
			
            $('#menu').hide();
            init();
			
			
		}
		
		/**
		 * Window resize event.
		 */
		window.addEventListener('resize', () => {
			
			// Update player camera
            player.camera.aspect = window.innerWidth / window.innerHeight;
            player.camera.updateProjectionMatrix();
			
			// Update game renderer
            renderer.setSize(window.innerWidth, window.innerHeight);
			
        });
		
		
		// Editor UI Events
		
		// Editor Title Window
		
		/**
		 * Editor world name text changed event.
		 */
		$("#editor-world-name").change(function()
		{
			if (editor.enabled)
			{
				
				// Set world name
				world.name = $("#editor-world-name").val();
				
			}
		});
		
		/**
		 * Editor world new button click event.
		 */
		$("#editor-world-new").click(function()
		{
			if (editor.enabled)
			{
				
				// Create a new empty world
				world.editor.newWorld(player);
				
			}
		});
		
		/**
		 * Editor world load button click event.
		 */
		$("#editor-world-load").click(function()
		{
			if (editor.enabled)
			{
				
				// Load a world from a JSON file
				world.loadWorld(player);
				
			}
		});
		
		/**
		 * Editor world save button click event.
		 */
		$("#editor-world-save").click(function()
		{
			if (editor.enabled)
			{
				
				// Save the selected world as a JSON file
				world.saveWorld(player);
				
			}
		});
		
		
		// Editor Selected Object Window
		
		/**
		 * Editor selected object X-axis position
		 */
		 $("#editor-selected-object-position-x").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object X-axis position 
				world.editor.selected_object.position.x = $("#editor-selected-object-position-x").val();
				
			}
		});
		
		/**
		 * Editor selected object Y-axis position
		 */
		 $("#editor-selected-object-position-y").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object Y-axis position 
				world.editor.selected_object.position.y = $("#editor-selected-object-position-y").val();
				
			}
		});
		
		/**
		 * Editor selected object Z-axis position
		 */
		 $("#editor-selected-object-position-z").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object Z-axis position 
				world.editor.selected_object.position.z = $("#editor-selected-object-position-z").val();
				
			}
		});
		
		/**
		 * Editor selected object X-axis scale
		 */
		 $("#editor-selected-object-scale-x").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object X-axis scale 
				world.editor.selected_object.scale.x = $("#editor-selected-object-scale-x").val() / 100;
				
			}
		});
		
		/**
		 * Editor selected object Y-axis scale
		 */
		 $("#editor-selected-object-scale-y").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object Y-axis scale 
				world.editor.selected_object.scale.y = $("#editor-selected-object-scale-y").val() / 100;
				
			}
		});
		
		/**
		 * Editor selected object Z-axis scale
		 */
		 $("#editor-selected-object-scale-z").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object Z-axis scale 
				world.editor.selected_object.scale.z = $("#editor-selected-object-scale-z").val() / 100;
				
			}
		});
		
		/**
		 * Editor selected object X-axis rotation
		 */
		 $("#editor-selected-object-rotation-x").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object X-axis rotation by converting the input degrees to radians
				world.editor.selected_object.rotation.x = $("#editor-selected-object-rotation-x").val() * (Math.PI / 180);
				
			}
		});
		
		/**
		 * Editor selected object Y-axis rotation
		 */
		 $("#editor-selected-object-rotation-y").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object Y-axis rotation by converting the input degrees to radians
				world.editor.selected_object.rotation.y = $("#editor-selected-object-rotation-y").val()  * (Math.PI / 180);
				
			}
		});
		
		/**
		 * Editor selected object Z-axis rotation
		 */
		 $("#editor-selected-object-rotation-z").change(function()
		{
			if (editor.enabled)
			{
				
				// Set selected object Z-axis rotation by converting the input degrees to radians
				world.editor.selected_object.rotation.z = $("#editor-selected-object-rotation-z").val()  * (Math.PI / 180);
				
			}
		});
		
		
		// Main Menu UI Events
		
		/**
		 * Start button click event.
		 */
        $("#startGame").click(function()
		{
			
			// Hide main menu UI
            $('#menu').hide();
			
			// Initialize game
            init();
			
		});
		
		/**
		 * Exit button click event.
		 */
		 $("#exitGame").click(function()
		{
			
			// Close browser
            window.close();
			
		});
        
    </script>
	
</body>
</html>
