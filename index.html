<!DOCTYPE html>
<html lang="en">
<head>
	
	<!-- HTML Metadata -->
	
    <meta charset="UTF-8">
    <title>Game</title>
	<link rel="stylesheet" href="./style.css">
	
	
	<!-- Third-Party Imports - Bootstrap & jQuery -->
	
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	
</head>
<body>
	
	<!-- Special UIs -->
	
	<!-- Debug UI -->
	
	<div id="debug" class="mx-3" style="display: none;">
		<div class="row">
			<div class="col">
				<div class="card mt-3 shadow-sm">
					<div class="card-body">
						<p class="card-title small fw-bold">Debug Info</p>
						<p id="debug-text" class="card-text small mb-1"></p>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- Editor UI -->
	
	<div id="editor" class="mx-3" style="display: none;">
		<div id="editor-title" class="row">
			<div class="col-12 col-lg-7 col-xl-5">
				<div class="card p-2 mt-3 shadow-sm">
					<div class="input-group">
						<div class="card-title fw-bold input-group-text w-100 m-0">
							Edit World
							<input id="editor-world-name" class="form-control form-control-sm w-auto mx-3" type="text" placeholder="Enter your world's name."></p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="editor-selected-object" class="row" style="display: none;">
			<div class="col-6 col-sm-5 col-md-4 col-lg-3 col-xl-2">
				<div class="card p-2 mt-3 shadow-sm">
					<div class="card-title small-important fw-bold input-group-text w-100">
						Selected Object
					</div>
					<div class="mb-1">
						<label class="form-label small">Position</label>
						<div class="d-flex justify-content-center">
							<input id="editor-selected-object-position-x" class="form-control form-control-sm w-25 mx-1 mb-1" type="text" placeholder="X">
							<input id="editor-selected-object-position-y" class="form-control form-control-sm w-25 mx-1 mb-1" type="text" placeholder="Y">
							<input id="editor-selected-object-position-z" class="form-control form-control-sm w-25 mx-1 mb-1" type="text" placeholder="Z">
						</div>
					</div>
					<div class="mb-1">
						<label class="form-label small">Size</label>
						<div class="d-flex justify-content-center">
							<input id="editor-selected-object-width" class="form-control form-control-sm w-25 mx-1 mb-1" type="text" placeholder="Width">
							<input id="editor-selected-object-height" class="form-control form-control-sm w-25 mx-1 mb-1" type="text" placeholder="Height">
							<input id="editor-selected-object-depth" class="form-control form-control-sm w-25 mx-1 mb-1" type="text" placeholder="Depth">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- Menu UIs -->
	
	<!-- Main Menu -->
	
	<div id="menu" class="modal modal-sheet bg-body-secondary p-4 py-md-5">
		<div class="modal-dialog">
			<div class="modal-content rounded-4 shadow">
				<div class="modal-body p-5">
					<div class="d-flex justify-content-center">
						<h2 class="fw-bold mb-3">Main Menu</h2>
					</div>
					<div class="d-flex mb-3 justify-content-center">
						<button id="startGame" type="button" class="btn btn-lg btn-primary w-100">Start</button>
					</div>
					<div class="d-flex justify-content-center">
						<button id="exitGame" type="button" class="btn btn-lg btn-primary w-100">Exit</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- Game UI Elements -->
	
	<!-- Player Crosshair -->
	
	<div class="crosshair"></div>
	
	
	<!-- three.js Renderer -->
	
	<div id="renderer"></div>
	
	
	<!-- Game JS -->
	
    <script type="module">
		
		// Game Imports
		
		// three.js Import
		import * as THREE from './Three.js/three.js';
		import { PointerLockControls } from './Three.js/Modules/PointerLockControls.js';
		
		// Class Imports
		import Player from './Classes/player.class.js';
		import World from './Classes/world.class.js';
		
		// Game World Imports
		import * as Worlds from './Worlds/worlds.js';
		
		
		// Game Declarations
		
		// three.js Game Renderer
        let renderer, render_once, stop_animating;
		
		// Game Player
		let player;
		
		// Game World
		let worlds, selected_world;
		
		
		// Game Functions
		
		/**
		 * Game Initialization - Initializes the renderer/player/world, then starts the game loop.
		 */
		function init()
		{
			
			// Initialize three.js renderer
			renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			
			render_once = false;
			stop_animating = false;
			
			$('#renderer').append(renderer.domElement);
			
			// Initialize worlds
			worlds = [];
			
			// Initialize custom game worlds from Worlds class
			for (const world_class in Worlds)
			{
				const game_world = new Worlds[world_class];
				if (game_world.world)
				{
					worlds.push(game_world.world);
				}
			}
			
			// Load game world
			if (worlds.length > 0)
			{
				
				// Select the first available game world by default
				selected_world = worlds[0];
				
				// Initialize player
				player = new Player(window, document, renderer, selected_world);
				
				// Start game loop
				animate();
				
			}
			else
			{
				// TODO: No game worlds loaded, crash the game? :(
			}
			
		}
		
		/**
		 * Game Loop - Handles processes that update every frame, then renders the frame.
		 */
		function animate()
		{
			
			// Request a frame to be rendered using this method as a callback
			const frame_id = requestAnimationFrame(animate);
			
			// Make sure at least one frame is rendered (This is workaround for collision bounding boxes before handling ANY collision detection...)
			//
			// 	NOTE: One frame must be initially rendered because the THREE.Box3().setFromObject() function expects objects to have a 
			//	      matrixWorld property that is up-to-date first, so rendering a single frame before collision detection prevents a crash.
			if (render_once)
			{
				
				// Handle player movement and collision detection
				player.handlePlayerMovement(selected_world);
				
				// Handle editor mode processes that update every frame
				player.handleEditorMode(selected_world);
				
				// Handle debug mode processes that update every frame
				player.handleDebugMode(selected_world);
				
			}
			else
			{
				render_once = true;
			}
			
			// Render the frame (or break game loop if flag is set)
			if (!stop_animating)
			{
				renderer.render(selected_world.scene, player.camera);
			}
			else
			{
				cancelAnimationFrame(frame_id);
				
				// TODO: Game loop broken. Do something? Show main menu?
			}
			
		}
		
		
		// Browser Window Event Handlers
		
		/**
		 * Window load event.
		 */
		window.onload = function(e)
		{ 
			// TODO: Remove everything in this function so it does nothing...
			
            $('#menu').hide();
            init();
			
			player.toggleEditorMode(selected_world);
		}
		
		/**
		 * Window resize event.
		 */
		window.addEventListener('resize', () => {
			
			// Update player camera
            player.camera.aspect = window.innerWidth / window.innerHeight;
            player.camera.updateProjectionMatrix();
			
			// Update game renderer
            renderer.setSize(window.innerWidth, window.innerHeight);
			
        });
		
		
		// Editor UI Events
		
		/**
		 * Editor world name text changed event.
		 */
		$("editor-world-name").change(function()
		{
			if (this.controls.mode_editor)
			{
				
				// Set world ame
				world.name = $("editor-world-name").val();
				
			}
		});
		
		
		// Main Menu UI Events
		
		/**
		 * Start button click event.
		 */
        $("#startGame").click(function()
		{
			
			// Hide main menu UI
            $('#menu').hide();
			
			// Initialize game
            init();
			
		});
		
		/**
		 * Exit button click event.
		 */
		 $("#exitGame").click(function()
		{
			
			// Close browser
            window.close();
			
		});
        
    </script>
	
</body>
</html>
